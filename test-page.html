<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç —Å–∫—Ä–∏–ø—Ç–∞ –ø—Ä–æ—Ñ–∏–ª—è</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f8f9fa;
        }
        
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 30px;
        }
        
        .test-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .test-controls {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        
        .test-controls h3 {
            margin-top: 0;
            color: #495057;
        }
        
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        
        .test-button:hover {
            background: #0056b3;
        }
        
        .test-input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 5px;
            width: 250px;
        }
        
        .console-output {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1>üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ –ø—Ä–æ—Ñ–∏–ª—è</h1>
            <p>–≠—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ–º–æ–∂–µ—Ç –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–±–æ—Ç—É —Å–∫—Ä–∏–ø—Ç–∞ –¥–ª—è –¢–∏–ª—å–¥—ã</p>
        </div>
        
        <div class="test-controls">
            <h3>üéÆ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–º</h3>
            
            <div style="margin-bottom: 15px;">
                <input type="email" id="testEmail" class="test-input" placeholder="–í–≤–µ–¥–∏—Ç–µ email –¥–ª—è —Ç–µ—Å—Ç–∞" value="barbarosgroup2024@gmail.com">
                <button class="test-button" onclick="testWithEmail()">üîç –¢–µ—Å—Ç —Å email</button>
            </div>
            
            <div style="margin-bottom: 15px;">
                <button class="test-button" onclick="simulateTildaUser()">üë§ –°–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¢–∏–ª—å–¥—ã</button>
                <button class="test-button" onclick="loadProfile()">üìã –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
                <button class="test-button" onclick="clearResults()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
            </div>
            
            <div>
                <button class="test-button" onclick="checkTildaEmail()">üìß –ü—Ä–æ–≤–µ—Ä–∏—Ç—å email –≤ –¢–∏–ª—å–¥–µ</button>
                <button class="test-button" onclick="testAPI()">üåê –¢–µ—Å—Ç API</button>
                <button class="test-button" onclick="showConsole()">üìù –ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–Ω—Å–æ–ª—å</button>
            </div>
        </div>
        
        <div id="results-area">
            <!-- –ó–¥–µ—Å—å –±—É–¥—É—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
        </div>
        
        <div class="console-output" id="console-output" style="display: none;">
            <strong>–ö–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞:</strong><br>
            <div id="console-content"></div>
        </div>
    </div>

    <script>
        // –ü–æ–¥–∫–ª—é—á–∞–µ–º –Ω–∞—à –æ—Å–Ω–æ–≤–Ω–æ–π —Å–∫—Ä–∏–ø—Ç
        // URL –≤–∞—à–µ–≥–æ –±—ç–∫–µ–Ω–¥–∞ –Ω–∞ Railway
        const BACKEND_URL = 'https://tilda-backend-production.up.railway.app';
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è email –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –¢–∏–ª—å–¥–µ
        function getTildaUserEmail() {
            // –°–ø–æ—Å–æ–± 1: –ò–∑ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –¢–∏–ª—å–¥—ã
            if (window.tildaForm && window.tildaForm.userEmail) {
                return window.tildaForm.userEmail;
            }
            
            if (window.currentUser && window.currentUser.email) {
                return window.currentUser.email;
            }
            
            // –°–ø–æ—Å–æ–± 2: –ò–∑ localStorage (–≥–¥–µ –¢–∏–ª—å–¥–∞ –º–æ–∂–µ—Ç —Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
            const userEmail = localStorage.getItem('tilda_user_email') || 
                             localStorage.getItem('user_email') ||
                             localStorage.getItem('memberEmail') ||
                             sessionStorage.getItem('tilda_user_email');
            if (userEmail) return userEmail;
            
            // –°–ø–æ—Å–æ–± 3: –ò–∑ cookies
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'tilda_user_email' || name === 'user_email' || name === 'memberEmail') {
                    return decodeURIComponent(value);
                }
            }
            
            // –°–ø–æ—Å–æ–± 4: –ò–∑ —Å–∫—Ä—ã—Ç—ã—Ö –ø–æ–ª–µ–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ (–µ—Å–ª–∏ –¢–∏–ª—å–¥–∞ –∏—Ö —Å–æ–∑–¥–∞–µ—Ç)
            const hiddenEmailInput = document.querySelector('input[name="email"][type="hidden"]') ||
                                     document.querySelector('input[name="user_email"][type="hidden"]');
            if (hiddenEmailInput && hiddenEmailInput.value) {
                return hiddenEmailInput.value;
            }
            
            // –°–ø–æ—Å–æ–± 5: –ò–∑ —Ç–µ–∫—Å—Ç–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ (–µ—Å–ª–∏ email –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≥–¥–µ-—Ç–æ)
            const emailRegex = /[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/g;
            const pageText = document.body.innerText;
            const emailMatches = pageText.match(emailRegex);
            if (emailMatches && emailMatches.length > 0) {
                // –ë–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π –Ω–∞–π–¥–µ–Ω–Ω—ã–π email
                return emailMatches[0];
            }
            
            return null;
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —Å–µ—Ä–≤–µ—Ä–∞
        async function fetchUserData(email) {
            try {
                logToConsole('–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è email: ' + email);
                
                const response = await fetch(`${BACKEND_URL}/user?email=${encodeURIComponent(email)}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                logToConsole('–ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ' + JSON.stringify(result, null, 2));
                
                return result.data;
            } catch (error) {
                logToConsole('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ' + error.message);
                return null;
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
        function displayUserData(userData, email) {
            const container = document.getElementById('results-area');
            
            if (userData) {
                container.innerHTML = `
                    <div style="
                        max-width: 600px;
                        margin: 20px auto;
                        padding: 30px;
                        background: white;
                        border-radius: 12px;
                        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
                        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                    ">
                        <div style="text-align: center; margin-bottom: 30px;">
                            <h2 style="color: #333; margin-bottom: 10px;">üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h2>
                            <p style="color: #666;">–í–∞—à–∏ –ª–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</p>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #007bff;">
                                <strong style="color: #495057; display: block; margin-bottom: 5px;">üìß Email</strong>
                                <span style="color: #212529;">${userData.email || email}</span>
                            </div>
                            
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #28a745;">
                                <strong style="color: #495057; display: block; margin-bottom: 5px;">üë§ –ò–º—è</strong>
                                <span style="color: #212529;">${userData.name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</span>
                            </div>
                            
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #ffc107;">
                                <strong style="color: #495057; display: block; margin-bottom: 5px;">üéØ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</strong>
                                <span style="color: #212529; font-family: monospace; font-size: 12px;">${userData.id || '–ù–µ —É–∫–∞–∑–∞–Ω'}</span>
                            </div>
                            
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #17a2b8;">
                                <strong style="color: #495057; display: block; margin-bottom: 5px;">üìÖ –î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</strong>
                                <span style="color: #212529;">${userData.created_at ? new Date(userData.created_at).toLocaleDateString('ru-RU') : '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</span>
                            </div>
                        </div>
                        
                        <div style="text-align: center; margin-top: 30px;">
                            <button onclick="loadProfile()" style="
                                background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
                                color: white;
                                border: none;
                                padding: 12px 24px;
                                border-radius: 6px;
                                cursor: pointer;
                                font-size: 14px;
                                font-weight: 500;
                            ">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
                        </div>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #dc3545; background: #f8d7da; border-radius: 8px;">
                        <h3 style="margin-bottom: 15px;">‚ùå –î–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
                        <p>–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å email: <strong>${email}</strong></p>
                        <p style="margin-top: 15px; font-size: 14px; color: #6c757d;">
                            –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
                        </p>
                    </div>
                `;
            }
        }
        
        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        function logToConsole(message) {
            console.log(message);
            const consoleContent = document.getElementById('console-content');
            const timestamp = new Date().toLocaleTimeString();
            consoleContent.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            consoleContent.scrollTop = consoleContent.scrollHeight;
        }
        
        function showConsole() {
            const consoleOutput = document.getElementById('console-output');
            consoleOutput.style.display = consoleOutput.style.display === 'none' ? 'block' : 'none';
        }
        
        function clearResults() {
            document.getElementById('results-area').innerHTML = '';
            document.getElementById('console-content').innerHTML = '';
        }
        
        async function testWithEmail() {
            const email = document.getElementById('testEmail').value;
            if (!email) {
                alert('–í–≤–µ–¥–∏—Ç–µ email –¥–ª—è —Ç–µ—Å—Ç–∞');
                return;
            }
            
            logToConsole('–¢–µ—Å—Ç–∏—Ä—É–µ–º —Å email: ' + email);
            const userData = await fetchUserData(email);
            displayUserData(userData, email);
        }
        
        function simulateTildaUser() {
            const email = document.getElementById('testEmail').value;
            if (!email) {
                alert('–í–≤–µ–¥–∏—Ç–µ email –¥–ª—è —Å–∏–º—É–ª—è—Ü–∏–∏');
                return;
            }
            
            // –°–∏–º—É–ª–∏—Ä—É–µ–º —Ä–∞–∑–ª–∏—á–Ω—ã–µ —Å–ø–æ—Å–æ–±—ã —Ö—Ä–∞–Ω–µ–Ω–∏—è email –≤ –¢–∏–ª—å–¥–µ
            localStorage.setItem('tilda_user_email', email);
            window.currentUser = { email: email };
            
            logToConsole('–°–∏–º—É–ª–∏—Ä–æ–≤–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¢–∏–ª—å–¥—ã —Å email: ' + email);
            logToConsole('–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã: localStorage.tilda_user_email –∏ window.currentUser.email');
        }
        
        async function loadProfile() {
            logToConsole('–ù–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...');
            
            // –ü–æ–ª—É—á–∞–µ–º email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const email = getTildaUserEmail();
            logToConsole('–ù–∞–π–¥–µ–Ω email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ' + (email || '–ù–ï –ù–ê–ô–î–ï–ù'));
            
            if (!email) {
                document.getElementById('results-area').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #ffc107; background: #fff3cd; border-radius: 8px;">
                        <h3 style="margin-bottom: 15px;">‚ö†Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω</h3>
                        <p>–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å email –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.</p>
                        <p style="margin-top: 15px; font-size: 14px; color: #6c757d;">
                            –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É "–°–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¢–∏–ª—å–¥—ã" –¥–ª—è —Ç–µ—Å—Ç–∞
                        </p>
                    </div>
                `;
                return;
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const userData = await fetchUserData(email);
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            displayUserData(userData, email);
        }
        
        function checkTildaEmail() {
            const email = getTildaUserEmail();
            logToConsole('–ü—Ä–æ–≤–µ—Ä–∫–∞ email –≤ –¢–∏–ª—å–¥–µ: ' + (email || '–ù–ï –ù–ê–ô–î–ï–ù'));
            
            if (email) {
                alert('–ù–∞–π–¥–µ–Ω email: ' + email);
            } else {
                alert('Email –Ω–µ –Ω–∞–π–¥–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ "–°–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¢–∏–ª—å–¥—ã"');
            }
        }
        
        async function testAPI() {
            const email = document.getElementById('testEmail').value;
            if (!email) {
                alert('–í–≤–µ–¥–∏—Ç–µ email –¥–ª—è —Ç–µ—Å—Ç–∞ API');
                return;
            }
            
            try {
                logToConsole('–¢–µ—Å—Ç–∏—Ä—É–µ–º API —Å email: ' + email);
                const response = await fetch(`${BACKEND_URL}/user?email=${encodeURIComponent(email)}`);
                const result = await response.json();
                
                logToConsole('–û—Ç–≤–µ—Ç API: ' + JSON.stringify(result, null, 2));
                
                if (response.ok) {
                    alert('‚úÖ API —Ä–∞–±–æ—Ç–∞–µ—Ç! –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–π–¥–µ–Ω.');
                } else {
                    alert('‚ùå API –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É: ' + result.error);
                }
            } catch (error) {
                logToConsole('–û—à–∏–±–∫–∞ API: ' + error.message);
                alert('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ API: ' + error.message);
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        logToConsole('–¢–µ—Å—Ç–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
        logToConsole('Backend URL: ' + BACKEND_URL);
    </script>
</body>
</html>